# =================================================================
# Configuración de Mosquitto MQTT Broker para SENA Acuaponía
# Versión: 3.0.0 - Optimizada para el nuevo formato de topics
# Author: Kevin Mariano 
# =================================================================

# -----------------------------------------------------------------
# CONFIGURACIÓN BÁSICA DE CONEXIÓN
# -----------------------------------------------------------------

# Puerto estándar MQTT
port 1883

# Puerto WebSocket para conexiones web
listener 9001
protocol websockets

# Configuración de keep-alive
keepalive_interval 60
max_keepalive 120

# Configuración de conexiones
max_connections -1
connection_messages true

# -----------------------------------------------------------------
# CONFIGURACIÓN DE PERSISTENCIA
# -----------------------------------------------------------------

# Habilitar persistencia de mensajes
persistence true
persistence_location /mosquitto/data/

# Archivo de base de datos de persistencia
persistence_file mosquitto.db

# Limpiar sesiones al inicio (recomendado para desarrollo)
persistent_client_expiration 1d

# -----------------------------------------------------------------
# CONFIGURACIÓN DE LOGGING
# -----------------------------------------------------------------

# Destino del log
log_dest file /mosquitto/log/mosquitto.log
log_dest stdout

# Tipos de eventos a registrar
log_type error
log_type warning
log_type notice
log_type information
log_type debug

# Configuración de timestamps y formato
log_timestamp true
log_timestamp_format %Y-%m-%d %H:%M:%S

# -----------------------------------------------------------------
# CONFIGURACIÓN DE SEGURIDAD
# -----------------------------------------------------------------

# Permitir conexiones anónimas (solo para desarrollo)
# En producción, cambiar a false y configurar autenticación
allow_anonymous true

# Configuración para producción (descomentar cuando sea necesario):
# allow_anonymous false
# password_file /mosquitto/config/passwd
# acl_file /mosquitto/config/acl

# -----------------------------------------------------------------
# CONFIGURACIÓN DE MENSAJES Y COLAS
# -----------------------------------------------------------------

# Límites de mensajes en vuelo
max_inflight_messages 20
max_queued_messages 1000

# Límites de QoS
max_queued_bytes 0
queue_qos0_messages true

# Configuración de retained messages
retained_persistence true

# Límite de tamaño de mensaje (0 = sin límite)
message_size_limit 0

# -----------------------------------------------------------------
# CONFIGURACIÓN ESPECÍFICA PARA SENSORES ACUAPÓNICOS
# -----------------------------------------------------------------

# El nuevo formato de topics es: {hardwareId}
# Ejemplos:
# - TEMP001
# - PH002  
# - OX003
# - SENSOR_TEMPERATURA_TANQUE_A
# - SENSOR_PH_TANQUE_B

# Topics del sistema:
# - acuaponia/status/backend      (estado del backend)
# - acuaponia/clients/status      (estado de clientes web)
# - acuaponia/system/alerts       (alertas del sistema)

# -----------------------------------------------------------------
# CONFIGURACIÓN DE RENDIMIENTO
# -----------------------------------------------------------------

# Buffer de socket
sys_interval 10

# Configuración de memory
memory_limit 0

# Configuración para múltiples clientes
per_listener_settings false

# -----------------------------------------------------------------
# CONFIGURACIÓN DE BRIDGE (para integración con otros brokers)
# -----------------------------------------------------------------

# Deshabilitado por defecto
# connection bridge-01
# address otro-broker.ejemplo.com:1883
# topic sensores/# out 0
# topic alertas/# in 0

# -----------------------------------------------------------------
# CONFIGURACIÓN DE WEBSOCKETS
# -----------------------------------------------------------------

# Configuración específica para el listener WebSocket
listener 9001
protocol websockets
socket_domain ipv4

# Headers HTTP para WebSocket (opcional)
# http_dir /var/www/mosquitto

# -----------------------------------------------------------------
# CONFIGURACIÓN DE MONITOREO
# -----------------------------------------------------------------

# Topic para estadísticas del broker
# Publicar estadísticas cada 30 segundos
# $SYS topics habilitados por defecto

# -----------------------------------------------------------------
# CONFIGURACIÓN DE DESARROLLO VS PRODUCCIÓN
# -----------------------------------------------------------------

# Para desarrollo:
allow_anonymous true
log_type debug

# Para producción (descomentar y configurar):
# allow_anonymous false
# password_file /mosquitto/config/passwd
# acl_file /mosquitto/config/acl
# certfile /mosquitto/config/server.crt
# keyfile /mosquitto/config/server.key
# tls_version tlsv1.2

# -----------------------------------------------------------------
# CONFIGURACIÓN DE TOPICS ESPECÍFICOS
# -----------------------------------------------------------------

# Patrón de topics para datos de sensores: {hardwareId}
# Validación de formato se hace en el backend

# Topics de sistema reservados:
# - acuaponia/*          (reservado para el sistema)
# - $SYS/*              (estadísticas de Mosquitto)

# -----------------------------------------------------------------
# CONFIGURACIÓN DE ALERTAS Y NOTIFICACIONES
# -----------------------------------------------------------------

# Topic para alertas del sistema
# acuaponia/system/alerts

# Topic para notificaciones a usuarios
# acuaponia/notifications/{userId}

# -----------------------------------------------------------------
# CONFIGURACIÓN DE BACKUP Y RECUPERACIÓN
# -----------------------------------------------------------------

# Intervalo de guardado automático (segundos)
autosave_interval 1800

# Escribir al disco cuando hay cambios
autosave_on_changes false

# -----------------------------------------------------------------
# CONFIGURACIÓN AVANZADA
# -----------------------------------------------------------------

# Configuración de cliente
clientid_prefixes

# Configuración de protocolo
protocol_version_limit 5

# Configuración de upgrade
upgrade_outgoing_qos false

# -----------------------------------------------------------------
# CONFIGURACIÓN DE LÍMITES DEL SISTEMA
# -----------------------------------------------------------------

# Límites por cliente
max_connections -1
max_inflight_messages 20
max_queued_messages 1000

# Configuración de timeout
keepalive_interval 60
retry_interval 20

# -----------------------------------------------------------------
# NOTAS DE CONFIGURACIÓN
# -----------------------------------------------------------------

# 1. El nuevo formato de topics simplificado es: {hardwareId}
# 2. No se usan prefijos como "sena/acuaponia/sensors/"
# 3. El backend busca sensores por hardwareId directamente
# 4. Topics de sistema usan el prefijo "acuaponia/"
# 5. Logs detallados para depuración y monitoreo
# 6. Configuración optimizada para IoT con múltiples sensores
# 7. Persistencia habilitada para no perder mensajes
# 8. WebSocket habilitado para clientes web
# 9. Configuración preparada para producción (comentada)
# 10. Monitoreo y estadísticas habilitados

# =================================================================
# FIN DE CONFIGURACIÓN
# =================================================================